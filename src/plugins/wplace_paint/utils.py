import re
from dataclasses import dataclass


@dataclass
class WplacePixelCoords:
    # each tile contains 1000x1000 pixels, from 0 to 999
    tlx: int  # tile X
    tly: int  # tile Y
    pxx: int  # pixel X
    pxy: int  # pixel Y

    def human_repr(self) -> str:
        return f"Tl X: {self.tlx}, Tl Y: {self.tly}, Px X: {self.pxx}, Px Y: {self.pxy}"

    def offset(self, dx: int, dy: int) -> "WplacePixelCoords":
        x = self.tlx * 1000 + self.pxx + dx
        y = self.tly * 1000 + self.pxy + dy
        return WplacePixelCoords(x // 1000, y // 1000, x % 1000, y % 1000)


def fix_coords(
    coord1: WplacePixelCoords,
    coord2: WplacePixelCoords,
) -> tuple[WplacePixelCoords, WplacePixelCoords]:
    x1, x2 = sorted((coord1.tlx * 1000 + coord1.pxx, coord2.tlx * 1000 + coord2.pxx))
    y1, y2 = sorted((coord1.tly * 1000 + coord1.pxy, coord2.tly * 1000 + coord2.pxy))
    return (
        WplacePixelCoords(x1 // 1000, y1 // 1000, x1 % 1000, y1 % 1000),
        WplacePixelCoords(x2 // 1000, y2 // 1000, x2 % 1000, y2 % 1000),
    )


def get_all_tile_coords(
    coord1: WplacePixelCoords,
    coord2: WplacePixelCoords,
) -> list[tuple[int, int]]:
    coord1, coord2 = fix_coords(coord1, coord2)
    return [
        (x, y)
        for x in range(coord1.tlx, coord2.tlx + 1)
        for y in range(coord1.tly, coord2.tly + 1)
    ]


def get_size(
    coord1: WplacePixelCoords,
    coord2: WplacePixelCoords,
) -> tuple[int, int]:
    coord1, coord2 = fix_coords(coord1, coord2)
    width = (coord2.tlx - coord1.tlx) * 1000 + (coord2.pxx - coord1.pxx) + 1
    height = (coord2.tly - coord1.tly) * 1000 + (coord2.pxy - coord1.pxy) + 1
    return width, height


BLUE_MARBLE_COORDS_PATTERN = re.compile(
    r".+?Tl X: (\d+), Tl Y: (\d+), Px X: (\d+), Px Y: (\d+).+?"
)


def parse_coords(s: str) -> WplacePixelCoords:
    if not (m := BLUE_MARBLE_COORDS_PATTERN.match(s)):
        raise ValueError(f"Invalid coords: {s}")
    return WplacePixelCoords(int(m[1]), int(m[2]), int(m[3]), int(m[4]))


FLAG_MAPPING = {
    1: "ðŸ‡¦ðŸ‡«",
    2: "ðŸ‡¦ðŸ‡±",
    3: "ðŸ‡©ðŸ‡¿",
    4: "ðŸ‡¦ðŸ‡¸",
    5: "ðŸ‡¦ðŸ‡©",
    6: "ðŸ‡¦ðŸ‡´",
    7: "ðŸ‡¦ðŸ‡®",
    8: "ðŸ‡¦ðŸ‡¶",
    9: "ðŸ‡¦ðŸ‡¬",
    10: "ðŸ‡¦ðŸ‡·",
    11: "ðŸ‡¦ðŸ‡²",
    12: "ðŸ‡¦ðŸ‡¼",
    13: "ðŸ‡¦ðŸ‡º",
    14: "ðŸ‡¦ðŸ‡¹",
    15: "ðŸ‡¦ðŸ‡¿",
    16: "ðŸ‡§ðŸ‡¸",
    17: "ðŸ‡§ðŸ‡­",
    18: "ðŸ‡§ðŸ‡©",
    19: "ðŸ‡§ðŸ‡§",
    20: "ðŸ‡§ðŸ‡¾",
    21: "ðŸ‡§ðŸ‡ª",
    22: "ðŸ‡§ðŸ‡¿",
    23: "ðŸ‡§ðŸ‡¯",
    24: "ðŸ‡§ðŸ‡²",
    25: "ðŸ‡§ðŸ‡¹",
    26: "ðŸ‡§ðŸ‡´",
    27: "ðŸ‡§ðŸ‡¶",
    28: "ðŸ‡§ðŸ‡¦",
    29: "ðŸ‡§ðŸ‡¼",
    30: "ðŸ‡§ðŸ‡»",
    31: "ðŸ‡§ðŸ‡·",
    32: "ðŸ‡®ðŸ‡´",
    33: "ðŸ‡§ðŸ‡³",
    34: "ðŸ‡§ðŸ‡¬",
    35: "ðŸ‡§ðŸ‡«",
    36: "ðŸ‡§ðŸ‡®",
    37: "ðŸ‡¨ðŸ‡»",
    38: "ðŸ‡°ðŸ‡­",
    39: "ðŸ‡¨ðŸ‡²",
    40: "ðŸ‡¨ðŸ‡¦",
    41: "ðŸ‡°ðŸ‡¾",
    42: "ðŸ‡¨ðŸ‡«",
    43: "ðŸ‡¹ðŸ‡©",
    44: "ðŸ‡¨ðŸ‡±",
    45: "ðŸ‡¨ðŸ‡³",
    46: "ðŸ‡¨ðŸ‡½",
    47: "ðŸ‡¨ðŸ‡¨",
    48: "ðŸ‡¨ðŸ‡´",
    49: "ðŸ‡°ðŸ‡²",
    50: "ðŸ‡¨ðŸ‡¬",
    51: "ðŸ‡¨ðŸ‡°",
    52: "ðŸ‡¨ðŸ‡·",
    53: "ðŸ‡­ðŸ‡·",
    54: "ðŸ‡¨ðŸ‡º",
    55: "ðŸ‡¨ðŸ‡¼",
    56: "ðŸ‡¨ðŸ‡¾",
    57: "ðŸ‡¨ðŸ‡¿",
    58: "ðŸ‡¨ðŸ‡®",
    59: "ðŸ‡©ðŸ‡°",
    60: "ðŸ‡©ðŸ‡¯",
    61: "ðŸ‡©ðŸ‡²",
    62: "ðŸ‡©ðŸ‡´",
    63: "ðŸ‡ªðŸ‡¨",
    64: "ðŸ‡ªðŸ‡¬",
    65: "ðŸ‡¸ðŸ‡»",
    66: "ðŸ‡¬ðŸ‡¶",
    67: "ðŸ‡ªðŸ‡·",
    68: "ðŸ‡ªðŸ‡ª",
    69: "ðŸ‡¸ðŸ‡¿",
    70: "ðŸ‡ªðŸ‡¹",
    71: "ðŸ‡«ðŸ‡°",
    72: "ðŸ‡«ðŸ‡´",
    73: "ðŸ‡«ðŸ‡¯",
    74: "ðŸ‡«ðŸ‡®",
    75: "ðŸ‡«ðŸ‡·",
    76: "ðŸ‡¬ðŸ‡«",
    77: "ðŸ‡µðŸ‡«",
    78: "ðŸ‡¹ðŸ‡«",
    79: "ðŸ‡¬ðŸ‡¦",
    80: "ðŸ‡¬ðŸ‡²",
    81: "ðŸ‡¬ðŸ‡ª",
    82: "ðŸ‡©ðŸ‡ª",
    83: "ðŸ‡¬ðŸ‡­",
    84: "ðŸ‡¬ðŸ‡®",
    85: "ðŸ‡¬ðŸ‡·",
    86: "ðŸ‡¬ðŸ‡±",
    87: "ðŸ‡¬ðŸ‡©",
    88: "ðŸ‡¬ðŸ‡µ",
    89: "ðŸ‡¬ðŸ‡º",
    90: "ðŸ‡¬ðŸ‡¹",
    91: "ðŸ‡¬ðŸ‡¬",
    92: "ðŸ‡¬ðŸ‡³",
    93: "ðŸ‡¬ðŸ‡¼",
    94: "ðŸ‡¬ðŸ‡¾",
    95: "ðŸ‡­ðŸ‡¹",
    96: "ðŸ‡­ðŸ‡²",
    97: "ðŸ‡­ðŸ‡³",
    98: "ðŸ‡­ðŸ‡°",
    99: "ðŸ‡­ðŸ‡º",
    100: "ðŸ‡®ðŸ‡¸",
    101: "ðŸ‡®ðŸ‡³",
    102: "ðŸ‡®ðŸ‡©",
    103: "ðŸ‡®ðŸ‡·",
    104: "ðŸ‡®ðŸ‡¶",
    105: "ðŸ‡®ðŸ‡ª",
    106: "ðŸ‡®ðŸ‡²",
    107: "ðŸ‡®ðŸ‡±",
    108: "ðŸ‡®ðŸ‡¹",
    109: "ðŸ‡¯ðŸ‡²",
    110: "ðŸ‡¯ðŸ‡µ",
    111: "ðŸ‡¯ðŸ‡ª",
    112: "ðŸ‡¯ðŸ‡´",
    113: "ðŸ‡°ðŸ‡¿",
    114: "ðŸ‡°ðŸ‡ª",
    115: "ðŸ‡°ðŸ‡®",
    116: "ðŸ‡½ðŸ‡°",
    117: "ðŸ‡°ðŸ‡¼",
    118: "ðŸ‡°ðŸ‡¬",
    119: "ðŸ‡±ðŸ‡¦",
    120: "ðŸ‡±ðŸ‡»",
    121: "ðŸ‡±ðŸ‡§",
    122: "ðŸ‡±ðŸ‡¸",
    123: "ðŸ‡±ðŸ‡·",
    124: "ðŸ‡±ðŸ‡¾",
    125: "ðŸ‡±ðŸ‡®",
    126: "ðŸ‡±ðŸ‡¹",
    127: "ðŸ‡±ðŸ‡º",
    128: "ðŸ‡²ðŸ‡´",
    129: "ðŸ‡²ðŸ‡¬",
    130: "ðŸ‡²ðŸ‡¼",
    131: "ðŸ‡²ðŸ‡¾",
    132: "ðŸ‡²ðŸ‡»",
    133: "ðŸ‡²ðŸ‡±",
    134: "ðŸ‡²ðŸ‡¹",
    135: "ðŸ‡²ðŸ‡­",
    136: "ðŸ‡²ðŸ‡¶",
    137: "ðŸ‡²ðŸ‡·",
    138: "ðŸ‡²ðŸ‡º",
    139: "ðŸ‡¾ðŸ‡¹",
    140: "ðŸ‡²ðŸ‡½",
    141: "ðŸ‡«ðŸ‡²",
    142: "ðŸ‡²ðŸ‡©",
    143: "ðŸ‡²ðŸ‡¨",
    144: "ðŸ‡²ðŸ‡³",
    145: "ðŸ‡²ðŸ‡ª",
    146: "ðŸ‡²ðŸ‡¸",
    147: "ðŸ‡²ðŸ‡¦",
    148: "ðŸ‡²ðŸ‡¿",
    149: "ðŸ‡²ðŸ‡²",
    150: "ðŸ‡³ðŸ‡¦",
    151: "ðŸ‡³ðŸ‡·",
    152: "ðŸ‡³ðŸ‡µ",
    153: "ðŸ‡³ðŸ‡±",
    154: "ðŸ‡³ðŸ‡¨",
    155: "ðŸ‡³ðŸ‡¿",
    156: "ðŸ‡³ðŸ‡®",
    157: "ðŸ‡³ðŸ‡ª",
    158: "ðŸ‡³ðŸ‡¬",
    159: "ðŸ‡³ðŸ‡º",
    160: "ðŸ‡³ðŸ‡«",
    161: "ðŸ‡°ðŸ‡µ",
    162: "ðŸ‡²ðŸ‡°",
    163: "ðŸ‡²ðŸ‡µ",
    164: "ðŸ‡³ðŸ‡´",
    165: "ðŸ‡´ðŸ‡²",
    166: "ðŸ‡µðŸ‡°",
    167: "ðŸ‡µðŸ‡¼",
    168: "ðŸ‡µðŸ‡¸",
    169: "ðŸ‡µðŸ‡¦",
    170: "ðŸ‡µðŸ‡¬",
    171: "ðŸ‡µðŸ‡¾",
    172: "ðŸ‡µðŸ‡ª",
    173: "ðŸ‡µðŸ‡­",
    174: "ðŸ‡µðŸ‡³",
    175: "ðŸ‡µðŸ‡±",
    176: "ðŸ‡µðŸ‡¹",
    177: "ðŸ‡µðŸ‡·",
    178: "ðŸ‡¶ðŸ‡¦",
    179: "ðŸ‡¨ðŸ‡©",
    180: "ðŸ‡·ðŸ‡´",
    181: "ðŸ‡·ðŸ‡º",
    182: "ðŸ‡·ðŸ‡¼",
    183: "ðŸ‡·ðŸ‡ª",
    184: "ðŸ‡§ðŸ‡±",
    185: "ðŸ‡¸ðŸ‡­",
    186: "ðŸ‡°ðŸ‡³",
    187: "ðŸ‡±ðŸ‡¨",
    188: "ðŸ‡²ðŸ‡«",
    189: "ðŸ‡µðŸ‡²",
    190: "ðŸ‡»ðŸ‡¨",
    191: "ðŸ‡¼ðŸ‡¸",
    192: "ðŸ‡¸ðŸ‡²",
    193: "ðŸ‡¸ðŸ‡¹",
    194: "ðŸ‡¸ðŸ‡¦",
    195: "ðŸ‡¸ðŸ‡³",
    196: "ðŸ‡·ðŸ‡¸",
    197: "ðŸ‡¸ðŸ‡¨",
    198: "ðŸ‡¸ðŸ‡±",
    199: "ðŸ‡¸ðŸ‡¬",
    200: "ðŸ‡¸ðŸ‡½",
    201: "ðŸ‡¸ðŸ‡°",
    202: "ðŸ‡¸ðŸ‡®",
    203: "ðŸ‡¸ðŸ‡§",
    204: "ðŸ‡¸ðŸ‡´",
    205: "ðŸ‡¿ðŸ‡¦",
    206: "ðŸ‡¬ðŸ‡¸",
    207: "ðŸ‡°ðŸ‡·",
    208: "ðŸ‡¸ðŸ‡¸",
    209: "ðŸ‡ªðŸ‡¸",
    210: "ðŸ‡±ðŸ‡°",
    211: "ðŸ‡¸ðŸ‡©",
    212: "ðŸ‡¸ðŸ‡·",
    213: "ðŸ‡¸ðŸ‡¯",
    214: "ðŸ‡¸ðŸ‡ª",
    215: "ðŸ‡¨ðŸ‡­",
    216: "ðŸ‡¸ðŸ‡¾",
    217: "ðŸ‡¹ðŸ‡¼",
    218: "ðŸ‡¹ðŸ‡¯",
    219: "ðŸ‡¹ðŸ‡¿",
    220: "ðŸ‡¹ðŸ‡­",
    221: "ðŸ‡¹ðŸ‡±",
    222: "ðŸ‡¹ðŸ‡¬",
    223: "ðŸ‡¹ðŸ‡°",
    224: "ðŸ‡¹ðŸ‡´",
    225: "ðŸ‡¹ðŸ‡¹",
    226: "ðŸ‡¹ðŸ‡³",
    227: "ðŸ‡¹ðŸ‡²",
    228: "ðŸ‡¹ðŸ‡¨",
    229: "ðŸ‡¹ðŸ‡»",
    230: "ðŸ‡¹ðŸ‡·",
    231: "ðŸ‡ºðŸ‡¬",
    232: "ðŸ‡ºðŸ‡¦",
    233: "ðŸ‡¦ðŸ‡ª",
    234: "ðŸ‡¬ðŸ‡§",
    235: "ðŸ‡ºðŸ‡¸",
    236: "ðŸ‡ºðŸ‡²",
    237: "ðŸ‡ºðŸ‡¾",
    238: "ðŸ‡ºðŸ‡¿",
    239: "ðŸ‡»ðŸ‡º",
    240: "ðŸ‡»ðŸ‡¦",
    241: "ðŸ‡»ðŸ‡ª",
    242: "ðŸ‡»ðŸ‡³",
    243: "ðŸ‡»ðŸ‡¬",
    244: "ðŸ‡»ðŸ‡®",
    245: "ðŸ‡¼ðŸ‡«",
    246: "ðŸ‡ªðŸ‡­",
    247: "ðŸ‡¾ðŸ‡ª",
    248: "ðŸ‡¿ðŸ‡²",
    249: "ðŸ‡¿ðŸ‡¼",
    250: "ðŸ‡¦ðŸ‡½",
    251: "ðŸ‡®ðŸ‡¨",
}


def get_flag_emoji(id: int) -> str:
    return FLAG_MAPPING.get(id, "")


FREE_COLORS = {
    "Black",
    "Dark Gray",
    "Gray",
    "Light Gray",
    "White",
    "Deep Red",
    "Red",
    "Orange",
    "Gold",
    "Yellow",
    "Light Yellow",
    "Dark Green",
    "Green",
    "Light Green",
    "Dark Teal",
    "Teal",
    "Light Teal",
    "Dark Blue",
    "Blue",
    "Cyan",
    "Indigo",
    "Light Indigo",
    "Dark Purple",
    "Purple",
    "Light Purple",
    "Dark Pink",
    "Pink",
    "Light Pink",
    "Dark Brown",
    "Brown",
    "Beige",
}

ALL_COLORS = {
    "Black": (0, 0, 0),
    "Dark Gray": (60, 60, 60),
    "Gray": (120, 120, 120),
    "Medium Gray": (170, 170, 170),
    "Light Gray": (210, 210, 210),
    "White": (255, 255, 255),
    "Deep Red": (96, 0, 24),
    "Dark Red": (165, 14, 30),
    "Red": (237, 28, 36),
    "Light Red": (250, 128, 114),
    "Dark Orange": (228, 92, 26),
    "Orange": (255, 127, 39),
    "Gold": (246, 170, 9),
    "Yellow": (249, 221, 59),
    "Light Yellow": (255, 250, 188),
    "Dark Goldenrod": (156, 132, 49),
    "Goldenrod": (197, 173, 49),
    "Light Goldenrod": (232, 212, 95),
    "Dark Olive": (74, 107, 58),
    "Olive": (90, 148, 74),
    "Light Olive": (132, 197, 115),
    "Dark Green": (14, 185, 104),
    "Green": (19, 230, 123),
    "Light Green": (135, 255, 94),
    "Dark Teal": (12, 129, 110),
    "Teal": (16, 174, 166),
    "Light Teal": (19, 225, 190),
    "Dark Cyan": (15, 121, 159),
    "Cyan": (96, 247, 242),
    "Light Cyan": (187, 250, 242),
    "Dark Blue": (40, 80, 158),
    "Blue": (64, 147, 228),
    "Light Blue": (125, 199, 255),
    "Dark Indigo": (77, 49, 184),
    "Indigo": (107, 80, 246),
    "Light Indigo": (153, 177, 251),
    "Dark Slate Blue": (74, 66, 132),
    "Slate Blue": (122, 113, 196),
    "Light Slate Blue": (181, 174, 241),
    "Dark Purple": (120, 12, 153),
    "Purple": (170, 56, 185),
    "Light Purple": (224, 159, 249),
    "Dark Pink": (203, 0, 122),
    "Pink": (236, 31, 128),
    "Light Pink": (243, 141, 169),
    "Dark Peach": (155, 82, 73),
    "Peach": (209, 128, 120),
    "Light Peach": (250, 182, 164),
    "Dark Brown": (104, 70, 52),
    "Brown": (149, 104, 42),
    "Light Brown": (219, 164, 99),
    "Dark Tan": (123, 99, 82),
    "Tan": (156, 132, 107),
    "Light Tan": (214, 181, 148),
    "Dark Beige": (209, 128, 81),
    "Beige": (248, 178, 119),
    "Light Beige": (255, 197, 165),
    "Dark Stone": (109, 100, 63),
    "Stone": (148, 140, 107),
    "Light Stone": (205, 197, 158),
    "Dark Slate": (51, 57, 65),
    "Slate": (109, 117, 141),
    "Light Slate": (179, 185, 209),
}

PAID_COLORS = set(ALL_COLORS) - FREE_COLORS


def find_color_name(rgba: tuple[int, int, int, int]) -> str:
    if rgba[3] == 0:
        return "Transparent"

    rgb = rgba[:3]
    for name, value in ALL_COLORS.items():
        if value == rgb:
            return name

    # not found, find the closest one
    def color_distance(c1: tuple[int, int, int], c2: tuple[int, int, int]) -> int:
        return sum((a - b) ** 2 for a, b in zip(c1, c2, strict=True))

    closest_name = ""
    closest_distance = float("inf")
    for name, value in ALL_COLORS.items():
        dist = color_distance(rgb, value)
        if dist < closest_distance:
            closest_distance = dist
            closest_name = name
    return closest_name
